apiVersion: v1
kind: Namespace
metadata:
  name: notary-verify-attestation
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keys
  namespace: notary-verify-attestation
data:
  certificate: |-
    -----BEGIN CERTIFICATE-----
    MIIDTTCCAjWgAwIBAgIJANo7ODK0bdaCMA0GCSqGSIb3DQEBCwUAMEwxCzAJBgNV
    BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwG
    Tm90YXJ5MQ0wCwYDVQQDDAR0ZXN0MB4XDTIzMDUxNDE1MjI1N1oXDTMzMDUxMTE1
    MjI1N1owTDELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0
    dGxlMQ8wDQYDVQQKDAZOb3RhcnkxDTALBgNVBAMMBHRlc3QwggEiMA0GCSqGSIb3
    DQEBAQUAA4IBDwAwggEKAoIBAQC0zT44OQ39a0sJQFtDLXufwlCx2yMygY9JCW5R
    1oPKxK1jcxmm7ECSyLmfMLno3mG8RLtyEMvIMr9ybsdGH0rC0CgXN9Yqr9IYtyvr
    dx9IGOVuCjZuJZvC496yMYe8X3BIHq2gMXGvH0cZII9HwZ9tF4POjAHeGfEhhnwW
    3rgSQpZnfAXe8wa1efNCF6hwiFcbYsott6ARAYnVzooyXJn6WlnzXI4Dx5BtcrjS
    L95X78L5XBsh3xx8zhJ9KudTJ9J+Fczku97XBtZuiB774zh6SUWm5iJTDHgHbt53
    49730youuse1g54DzeswapFuFMbSAUAFlV0QlzqIgQq39+gvAgMBAAGjMjAwMAkG
    A1UdEwQCMAAwDgYDVR0PAQH/BAQDAgeAMBMGA1UdJQQMMAoGCCsGAQUFBwMDMA0G
    CSqGSIb3DQEBCwUAA4IBAQAIdiULXAN3Q6DNTYWo6zdhybho0HfvTPDNMhOj64J2
    sIK4RZxPlP4YxbpFGrRaC6bfLLKq/7dP0S3PPMGvm05T4b7xQowvltcptdIUQl4A
    EGzoUZGtfr6FB+0Yhi3XWEoQ58bp4JiPrerIMiXtX5SgW1uQNu3dz4uptMCBSRSL
    d4vRsKbI5T+5xNNc5Vu25McegYMREkWxOUjS9rX9UGfcQOKaOZ1FtvNMxCjgKmI5
    3Zsxl3NjbEXUbyLEmgsAbniNkzjFi+6V2CqrqjnG8DzQ7V5P0V9UAWCL7lVIA2hb
    3eybzWJd+4kFw6aDPALhWMo9nLguLX/837SXfa693qWN
    -----END CERTIFICATE-----
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-image-attestation
spec:
  validationFailureAction: Enforce
  webhookTimeoutSeconds: 30
  failurePolicy: Fail  
  rules:
    - name: verify-attestation-notary
      match:
        any:
        - resources:
            kinds:
              - Pod
      context:
      - name: keys
        configMap:
          name: keys
          namespace: notary-verify-attestation
      verifyImages:
      - type: Notary
        imageReferences:
          - "ghcr.io/vishal-chdhry/monitor*"
        attestations:
          - type: application/vnd.cyclonedx+json
            attestors:
            - entries:
              - certificates: 
                  cert: "{{ keys.data.certificate }}"